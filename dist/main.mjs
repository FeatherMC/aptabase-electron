var g=(e,n,t)=>new Promise((s,o)=>{var a=c=>{try{r(t.next(c))}catch(l){o(l)}},i=c=>{try{r(t.throw(c))}catch(l){o(l)}},r=c=>c.done?s(c.value):Promise.resolve(c.value).then(a,i);r((t=t.apply(e,n)).next())});import{app as d,ipcMain as k,net as x,protocol as u}from"electron";import{exec as y}from"child_process";import{readFile as A}from"fs";import{release as E}from"os";var P="aptabase-electron@0.3.1";function S(e){return g(this,null,function*(){let[n,t]=yield I();return{appVersion:e.getVersion(),isDebug:!e.isPackaged,locale:e.getLocale(),osName:n,osVersion:t,engineName:"Chromium",engineVersion:process.versions.chrome,sdkVersion:P}})}function I(){return g(this,null,function*(){switch(process.platform){case"win32":return["Windows",E()];case"darwin":return["macOS",yield N()];default:return yield O()}})}function N(){return g(this,null,function*(){try{return(yield new Promise((n,t)=>{y("/usr/bin/sw_vers -productVersion",(s,o)=>{if(s){t(s);return}n(o)})})).trim()}catch(e){return""}})}function O(){return g(this,null,function*(){var e,n;try{let s=(yield new Promise((r,c)=>{A("/etc/os-release","utf8",(l,V)=>{if(l){c(l);return}r(V)})})).split(`
`),o={};for(let r of s){let[c,l]=r.split("=");c&&l&&(o[c]=l.replace(/"/g,""))}let a=(e=o.NAME)!=null?e:"Linux",i=(n=o.VERSION_ID)!=null?n:"";return[a,i]}catch(t){return["Linux",""]}})}function h(){let e=Math.floor(Date.now()/1e3).toString(),n=Math.floor(Math.random()*1e8).toString().padStart(8,"0");return e+n}var G=1*60*60,D=h(),_=new Date,m="",w="",p,v={US:"https://us.aptabase.com",EU:"https://eu.aptabase.com",DEV:"http://localhost:3000",SH:""};function W(e,n){return g(this,null,function*(){if(d.isReady()){console.warn("Aptabase: `initialize` must be invoked before the app is ready. Tracking will be disabled.");return}let t=e.split("-");if(t.length!==3||v[t[1]]===void 0){console.warn(`Aptabase: App Key "${e}" is invalid. Tracking will be disabled.`);return}M(),yield d.whenReady(),T(),w=`${H(t[1],n)}/api/v0/event`,p=yield S(d),m=e,R()})}var f=[];function b(e,n){if(!m||!p)return f.push({eventName:e,props:n}),Promise.resolve();let t=new Date;_=t;let s={timestamp:t.toISOString(),sessionId:D,eventName:e,systemProps:{isDebug:p.isDebug,locale:p.locale,osName:p.osName,osVersion:p.osVersion,engineName:p.engineName,engineVersion:p.engineVersion,appVersion:p.appVersion,sdkVersion:p.sdkVersion},props:n};return new Promise(o=>{let a=r=>{console.error("Aptabase: Failed to send event",r),o()},i=x.request({method:"POST",url:w,credentials:"omit"});i.setHeader("Content-Type","application/json"),i.setHeader("App-Key",m),i.on("error",a),i.on("abort",a),i.on("response",r=>{r.statusCode>=300&&console.warn(`Aptabase: Failed to send event "${e}": ${r.statusCode} ${r.statusMessage}`),o()}),i.write(JSON.stringify(s)),i.end()})}function R(){for(;f.length>0;){let e=f.shift();e&&b(e.eventName,e.props)}}function M(){u.registerSchemesAsPrivileged&&u.registerSchemesAsPrivileged([{scheme:"aptabase-ipc",privileges:{bypassCSP:!0,corsEnabled:!0,supportFetchAPI:!0,secure:!0}}])}function T(){k.on("aptabase:trackEvent",(e,n,t)=>{b(n,t).catch(s=>{console.error("Aptabase: Failed to send event",s)})}),u.registerStringProtocol&&u.registerStringProtocol("aptabase-ipc",(e,n)=>{var t,s,o;try{let a=(s=(t=e.uploadData)==null?void 0:t[0])==null?void 0:s.bytes,{eventName:i,props:r}=JSON.parse((o=a==null?void 0:a.toString())!=null?o:"{}");b(i,r)}catch(a){console.error("Aptabase: Failed to send event",a)}n("")})}function H(e,n){if(e==="SH"){if(!(n!=null&&n.host)){console.warn("Aptabase: Host parameter must be defined when using Self-Hosted App Key. Tracking will be disabled.");return}return n.host}return v[e]}export{W as initialize,b as trackEvent};
//# sourceMappingURL=main.mjs.map